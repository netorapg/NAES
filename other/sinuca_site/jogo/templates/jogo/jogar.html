{% extends 'base.html' %}
{% load static %}

{% block title %}{{ mesa.nome }} - Jogar Sinuca{% endblock %}

{% block extra_css %}
<style>
    .game-chat-wrapper {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
    }

    .chat-panel {
        width: 340px;
        min-width: 220px;
        max-width: 100%;
        background: #23272b;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(44,62,80,0.3);
        display: flex;
        flex-direction: column;
        height: 70vh;
        margin: 0;
    }
    .chat-header {
        background: #2c3e50;
        color: #fff;
        padding: 1rem;
        border-radius: 10px 10px 0 0;
        font-weight: bold;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        color: #ecf0f1;
        font-size: 0.98rem;
        background: #23272b;
        border-bottom: 1px solid #34495e;
    }
    .chat-message {
        margin-bottom: 0.7rem;
        word-break: break-word;
    }
    .chat-message .username {
        color: #e74c3c;
        font-weight: 600;
        margin-right: 0.4em;
    }
    .chat-message .timestamp {
        color: #7f8c8d;
        font-size: 0.85em;
        margin-left: 0.5em;
    }
    .chat-form {
        display: flex;
        gap: 0.5rem;
        padding: 0.8rem 1rem;
        background: #23272b;
        border-radius: 0 0 10px 10px;
    }
    .chat-form .input {
        flex: 1;
        border-radius: 20px;
        border: none;
        padding: 0.6rem 1rem;
        background: #34495e;
        color: #fff;
    }
    .chat-form .input:focus {
        outline: none;
        background: #2c3e50;
    }
    .chat-form .button {
        border-radius: 20px;
        font-weight: 600;
    }
    @media screen and (max-width: 1100px) {
        .game-chat-wrapper {
            flex-direction: column;
        }
        .chat-panel {
            width: 100%;
            height: 300px;
            margin-top: 1.5rem;
        }
        .game-container {
            width: 100%;
        }
    }
    .game-section {
        flex: 1;
        padding: 1rem;
        background: #1a1a1a;
        min-height: calc(100vh - 150px);
    }

    .game-header {
        background: rgba(0,0,0,0.8);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: white;
    }

    .game-container {
        height: 70vh;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }

    .game-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #2c3e50;
    }

    .players-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .player-card {
        background: linear-gradient(135deg, #34495e, #2c3e50);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .player-card.current-player {
        border-color: #e74c3c;
        box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
    }

    .player-avatar {
        width: 50px;
        height: 50px;
        background: #e74c3c;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-size: 1.5rem;
        color: white;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
    }

    .loading-spinner {
        border: 3px solid #34495e;
        border-top: 3px solid #e74c3c;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .game-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
    }

    .control-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .control-btn:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    .control-btn:disabled {
        background: #7f8c8d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .exit-btn {
        background: #7f8c8d;
    }

    .exit-btn:hover {
        background: #95a5a6;
    }

    @media screen and (max-width: 768px) {
        .game-container {
            height: 50vh;
        }
        
        .players-info {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-section">
    <div class="container">
        <!-- Cabeçalho do Jogo -->
        <div class="game-header">
            <div class="level">
                <div class="level-left">
                    <div>
                        <h1 class="title is-4 has-text-white mb-2">
                            <i class="fas fa-bowling-ball mr-2"></i>
                            {{ mesa.nome }}
                        </h1>
                        <div class="tags">
                            <span class="tag is-info">
                                <i class="fas fa-users mr-1"></i>
                                {{ jogadores.count }} jogadores
                            </span>
                            <span class="tag is-success">
                                {{ mesa.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="level-right">
                    <a href="{% url 'jogo:sinuca' %}" class="button is-light">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar às Mesas
                    </a>
                </div>
            </div>
        </div>

        <!-- Informações dos Jogadores -->
        <div class="players-info">
            {% for jogador in jogadores %}
            <div class="player-card {% if forloop.first %}current-player{% endif %}">
                <div class="player-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h3 class="title is-6 has-text-white">{{ jogador.username }}</h3>
                <p class="has-text-grey-light">
                    {% if jogador == mesa.criador %}
                        <i class="fas fa-crown has-text-warning mr-1"></i>
                        Host
                    {% else %}
                        <i class="fas fa-gamepad mr-1"></i>
                        Jogador
                    {% endif %}
                </p>
                <div class="mt-2">
                    <span class="tag is-primary">Pontos: 0</span>
                </div>
            </div>
            {% endfor %}
            
            <!-- Slots vazios -->
            {% if jogadores.count < mesa.max_jogadores %}
                {% for i in "x"|rjust:mesa.max_jogadores|slice:jogadores.count %}
                <div class="player-card">
                    <div class="player-avatar" style="background: #7f8c8d;">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h3 class="title is-6 has-text-grey">Aguardando jogador...</h3>
                    <p class="has-text-grey">Slot vazio</p>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Container do Jogo + Chat -->
        <div class="game-chat-wrapper">
            <div class="game-container">
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loading-spinner"></div>
                    <p class="has-text-white title is-5">Carregando jogo...</p>
                    <p class="has-text-grey-light">Preparando a mesa de sinuca</p>
                </div>
                <iframe 
                    src="{% static 'jogo/index.html' %}" 
                    class="game-iframe"
                    id="game-iframe"
                    onload="hideLoading()"
                    allow="autoplay; encrypted-media">
                    <div class="has-text-centered p-6">
                        <p class="title is-4 has-text-white">
                            <i class="fas fa-exclamation-triangle has-text-warning mr-2"></i>
                            Seu navegador não suporta o jogo
                        </p>
                        <p class="has-text-grey-light">
                            Por favor, utilize um navegador mais recente para jogar.
                        </p>
                    </div>
                </iframe>
            </div>
            <!-- Painel de Chat -->
            <div class="chat-panel" id="chat-panel">
                <div class="chat-header">
                    <i class="fas fa-comments mr-2"></i> Chat da Mesa
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Mensagens aparecerão aqui -->
                </div>
                <form class="chat-form" id="chat-form" autocomplete="off">
                    <input type="text" id="chat-input" class="input" placeholder="Digite sua mensagem..." maxlength="200" required />
                    <button type="submit" class="button is-primary">Enviar</button>
                </form>
            </div>
        </div>

        <!-- Controles do Jogo -->
        <div class="game-controls">
            <button class="control-btn" onclick="resetGame()" title="Reiniciar Jogo">
                <i class="fas fa-redo mr-2"></i>
                Reiniciar
            </button>
            
            <button class="control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
                <i class="fas fa-expand mr-2"></i>
                Tela Cheia
            </button>
            
            <button class="control-btn" onclick="toggleSound()" id="sound-btn" title="Som">
                <i class="fas fa-volume-up mr-2"></i>
                Som
            </button>
            
            <a href="{% url 'jogo:sair_mesa' mesa.id %}" 
               class="control-btn exit-btn"
               onclick="return confirm('Tem certeza que deseja sair da mesa?')"
               title="Sair da Mesa">
                <i class="fas fa-sign-out-alt mr-2"></i>
                Sair da Mesa
            </a>
        </div>

        <!-- Status da Conexão -->
        <div class="has-text-centered mt-4">
            <span class="tag is-success" id="connection-status">
                <i class="fas fa-wifi mr-1"></i>
                Conectado
            </span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Integração Supabase Realtime para chat
    const SUPABASE_URL = 'https://xzhxqnhzwklalgtvcvbi.supabase.co'; // Substitua pelo seu
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6aHhxbmh6d2tsYWxndHZjdmJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzOTc1NzQsImV4cCI6MjA2ODk3MzU3NH0.vAtuxG8FsgUluuzVflJpQcg3fcsEGj-ALkLrU-ZEgtM'; // Substitua pelo seu
    // Inicializa o client do Supabase após o script ser carregado
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // IDs vindos do backend Django
    const chatSystemId = '{{ mesa.chat_system }}';
    const userId = '{{ user.id }}';
    const username = '{{ user.username|default:"Você" }}';

    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // Checagem de chatSystemId
    if (!chatSystemId || chatSystemId === 'None' || chatSystemId === '') {
        alert('Erro: chatSystemId não definido. Não é possível carregar o chat.\nVerifique se a mesa possui um ID válido.');
        // Opcional: desabilita o chat
        if (chatForm) chatForm.querySelector('button[type="submit"]').disabled = true;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function appendChatMessage(user, text, time) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.innerHTML = `<span class="username">${user}</span> ${text} <span class="timestamp">${time}</span>`;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function loadMessages() {
        if (!chatSystemId || chatSystemId === 'None' || chatSystemId === '') return;
        const { data, error } = await supabaseClient
            .from('protocolos_chatmessage')
            .select('content, timestamp, sender:sender_id(username)')
            .eq('chat_system_id', chatSystemId)
            .order('timestamp', { ascending: true });
        if (data) {
            chatMessages.innerHTML = '';
            data.forEach(msg => {
                appendChatMessage(msg.sender?.username || 'Usuário', msg.content, formatTime(msg.timestamp));
            });
        }
    }

    // Escutar novas mensagens em tempo real
    function subscribeToMessages() {
        if (!chatSystemId || chatSystemId === 'None' || chatSystemId === '') return;
        supabaseClient.channel('public:protocolos_chatmessage')
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'protocolos_chatmessage',
                filter: `chat_system_id=eq.${chatSystemId}`
            }, payload => {
                const msg = payload.new;
                appendChatMessage(usernameFromId(msg.sender_id), msg.content, formatTime(msg.timestamp));
            })
            .subscribe();
    }

    // Busca username pelo id (cache simples)
    const userCache = {};
    function usernameFromId(id) {
        if (id === userId) return username;
        if (userCache[id]) return userCache[id];
        // fallback
        return 'Usuário';
    }

    // Enviar mensagem para o Supabase
    async function sendChatMessage(event) {
        event.preventDefault();
        if (!chatSystemId || chatSystemId === 'None' || chatSystemId === '') {
            alert('Erro: chatSystemId não definido. Não é possível enviar mensagens.');
            return;
        }
        const text = chatInput.value.trim();
        if (!text) return;
        // Log para depuração
        console.log({ content: text, sender_id: userId, chat_system_id: chatSystemId });
        const { data, error } = await supabaseClient.from('protocolos_chatmessage').insert([
            {
                id: generateUUID(),
                content: text,
                sender_id: userId,
                chat_system_id: chatSystemId,
                isPinned: false,
                type_id: 1,
            }
        ]);
        if (error) {
            alert('Erro ao enviar mensagem: ' + error.message);
            console.error(error);
            return;
        }
        chatInput.value = '';
    }

    function generateUUID() {
        // Gera um UUID v4 simples
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();
        subscribeToMessages();
        // Mensagem de boas-vindas local (opcional)
        // appendChatMessage('Sistema', 'Bem-vindo ao chat da mesa!', new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    });
    let isFullscreen = false;
    let soundEnabled = true;

    // Esconde o overlay de loading
    function hideLoading() {
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }, 2000);
    }

    // Reinicia o jogo
    function resetGame() {
        const iframe = document.getElementById('game-iframe');
        const overlay = document.getElementById('loading-overlay');
        
        if (confirm('Tem certeza que deseja reiniciar o jogo?')) {
            overlay.style.display = 'flex';
            iframe.src = iframe.src; // Recarrega o iframe
            
            // Reset visual dos jogadores
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('current-player');
            });
            
            // Primeiro jogador volta a ser o atual
            const firstPlayer = document.querySelector('.player-card');
            if (firstPlayer) {
                firstPlayer.classList.add('current-player');
            }
        }
    }

    // Toggle tela cheia
    function toggleFullscreen() {
        const gameContainer = document.querySelector('.game-container');
        const btn = event.target.closest('.control-btn');
        
        if (!isFullscreen) {
            if (gameContainer.requestFullscreen) {
                gameContainer.requestFullscreen();
            } else if (gameContainer.webkitRequestFullscreen) {
                gameContainer.webkitRequestFullscreen();
            } else if (gameContainer.msRequestFullscreen) {
                gameContainer.msRequestFullscreen();
            }
            
            btn.innerHTML = '<i class="fas fa-compress mr-2"></i>Sair Tela Cheia';
            isFullscreen = true;
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            
            btn.innerHTML = '<i class="fas fa-expand mr-2"></i>Tela Cheia';
            isFullscreen = false;
        }
    }

    // Toggle som
    function toggleSound() {
        const btn = document.getElementById('sound-btn');
        soundEnabled = !soundEnabled;
        
        if (soundEnabled) {
            btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Som';
            btn.title = 'Desativar Som';
        } else {
            btn.innerHTML = '<i class="fas fa-volume-mute mr-2"></i>Mudo';
            btn.title = 'Ativar Som';
        }
        
        // Aqui você pode enviar comando para o jogo se necessário
        const iframe = document.getElementById('game-iframe');
        iframe.contentWindow.postMessage({
            type: 'sound_toggle',
            enabled: soundEnabled
        }, '*');
    }

    // Detecta mudança de tela cheia
    document.addEventListener('fullscreenchange', function() {
        if (!document.fullscreenElement) {
            const btn = document.querySelector('[onclick="toggleFullscreen()"]');
            btn.innerHTML = '<i class="fas fa-expand mr-2"></i>Tela Cheia';
            isFullscreen = false;
        }
    });

    // Comunicação com o jogo
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'game_update') {
            // Aqui você pode atualizar o UI baseado no estado do jogo
            console.log('Atualização do jogo:', event.data);
        }
    });

    // Simula mudança de jogador atual (exemplo)
    function switchCurrentPlayer() {
        const players = document.querySelectorAll('.player-card');
        let currentIndex = 0;
        
        players.forEach((player, index) => {
            if (player.classList.contains('current-player')) {
                player.classList.remove('current-player');
                currentIndex = index;
            }
        });
        
        const nextIndex = (currentIndex + 1) % players.length;
        if (players[nextIndex] && !players[nextIndex].querySelector('.fas.fa-plus')) {
            players[nextIndex].classList.add('current-player');
        }
    }

    // Simulação de mudança de jogador a cada 30 segundos (apenas para demo)
    // setInterval(switchCurrentPlayer, 30000);
    // Adiciona o event listener do chat apenas após o DOM estar pronto
    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();
        subscribeToMessages();
        chatForm.addEventListener('submit', sendChatMessage);
        // Mensagem de boas-vindas local (opcional)
        // appendChatMessage('Sistema', 'Bem-vindo ao chat da mesa!', new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    });
</script>
{% endblock %}
