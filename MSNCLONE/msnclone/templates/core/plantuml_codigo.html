{% extends 'base.html' %}

{% block title %}Código PlantUML - MSN Clone{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h3><i class="fas fa-code"></i> Código PlantUML dos Diagramas</h3>
                    <p class="mb-0">Copie e cole estes códigos no <a href="http://www.plantuml.com/plantuml/uml/" target="_blank" class="text-white"><u>PlantUML Online</u></a> para visualizar os diagramas</p>
                </div>
                <div class="card-body">
                    
                    <!-- Navegação -->
                    <nav class="mb-4">
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <button class="nav-link active" id="nav-usecase-code-tab" data-bs-toggle="tab" data-bs-target="#nav-usecase-code" type="button" role="tab">
                                <i class="fas fa-users"></i> Código - Casos de Uso
                            </button>
                            <button class="nav-link" id="nav-classes-code-tab" data-bs-toggle="tab" data-bs-target="#nav-classes-code" type="button" role="tab">
                                <i class="fas fa-sitemap"></i> Código - Classes
                            </button>
                        </div>
                    </nav>

                    <div class="tab-content" id="nav-tabContent">
                        <!-- Código PlantUML - Casos de Uso -->
                        <div class="tab-pane fade show active" id="nav-usecase-code" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Diagrama de Casos de Uso - uso_caso_msn.puml</h5>
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('usecase-code')">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="card-body">
<pre id="usecase-code" class="bg-light p-3" style="font-size: 0.9em;"><code>@startuml CasosDeUsoMSNClone
!theme plain
skinparam backgroundColor white

title Casos de Uso - MSN Clone

left to right direction

' Atores
actor "Usuário Não\nAutenticado" as UNA
actor "Usuário\nAutenticado" as UA
actor "Sistema" as SYS

' Casos de Uso Principais
package "Sistema MSN Clone" {
    usecase (Registrar-se) as UC1
    usecase (Fazer Login) as UC2
    usecase (Fazer Logout) as UC3
    usecase (Visualizar Lista de Usuários) as UC4
    usecase (Enviar Pedido de Amizade) as UC5
    usecase (Aceitar/Recusar Pedido) as UC6
    usecase (Gerenciar Contatos) as UC7
    usecase (Iniciar Conversa) as UC8
    usecase (Enviar Mensagem) as UC9
    usecase (Receber Mensagem) as UC10
    usecase (Visualizar Status Online/Offline) as UC11
    usecase (Atualizar Última Atividade) as UC12
    usecase (Buscar Novas Mensagens) as UC13
    usecase (Gerenciar Perfil) as UC14
}

' Relacionamentos dos Atores com Casos de Uso

' Usuário Não Autenticado
UNA --> UC1
UNA --> UC2

' Usuário Autenticado
UA --> UC3
UA --> UC4
UA --> UC5
UA --> UC6
UA --> UC7
UA --> UC8
UA --> UC9
UA --> UC10
UA --> UC11
UA --> UC13
UA --> UC14

' Sistema (automático)
SYS --> UC12
SYS --> UC10

' Relacionamentos entre Casos de Uso
UC2 .> UC12 : <<include>>
UC8 .> UC7 : <<include>>
UC9 .> UC8 : <<include>>
UC13 .> UC10 : <<include>>
UC5 .> UC4 : <<include>>

' Extensões
UC6 .> UC7 : <<extend>>
UC11 .> UC12 : <<extend>>

' Notas explicativas
note right of UC12
  Atualizado automaticamente
  pelo middleware a cada
  requisição do usuário
end note

note bottom of UC13
  Executado via AJAX
  a cada 2 segundos para
  chat em tempo real
end note

note left of UC10
  Mensagens recebidas
  são exibidas automaticamente
  na interface do usuário
end note

@enduml</code></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Código PlantUML - Classes -->
                        <div class="tab-pane fade" id="nav-classes-code" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Diagrama de Classes - diagrama_classes_msn.puml</h5>
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('classes-code')">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="card-body">
<pre id="classes-code" class="bg-light p-3" style="font-size: 0.9em;"><code>@startuml DiagramaClassesMSNClone
!theme plain
skinparam backgroundColor white

title Diagrama de Classes - MSN Clone

' Django User (built-in)
class User {
    +id: Integer
    +username: String
    +email: String
    +first_name: String
    +last_name: String
    +password: String
    +is_active: Boolean
    +date_joined: DateTime
    --
    +save()
    +delete()
}

' Core Models
class Perfil {
    +id: Integer
    +usuario: OneToOneField(User)
    +frase: String
    +ultima_atividade: DateTime
    --
    +esta_online(): Boolean
    +status_display(): String
    +atualizar_atividade(): void
    +__str__(): String
}

class Status {
    +id: Integer
    +nome: String
    --
    +__str__(): String
}

class Contato {
    +id: Integer
    +solicitante: ForeignKey(User)
    +receptor: ForeignKey(User)
    +status: String
    +data_solicitacao: DateTime
    --
    +STATUS_CHOICES: Tuple
    +__str__(): String
}

class Conversa {
    +id: Integer
    +participantes: ManyToManyField(User)
    +data_criacao: DateTime
    --
    +__str__(): String
}

class Mensagem {
    +id: Integer
    +conversa: ForeignKey(Conversa)
    +remetente: ForeignKey(User)
    +conteudo: TextField
    +data_envio: DateTime
    --
    +__str__(): String
}

class Emoticon {
    +id: Integer
    +texto_atalho: String
    +imagem_emoticon: ImageField
    --
    +__str__(): String
}

' Views Classes
class HomeView {
    +template_name: String
    --
    +get(): HttpResponse
}

class UserListView {
    +model: User
    +template_name: String
    +context_object_name: String
    --
    +get_queryset(): QuerySet
}

class EnviarPedidoAmizadeView {
    --
    +post(request, pk): HttpResponse
}

class MeusContatosView {
    +template_name: String
    --
    +get_context_data(**kwargs): Dict
}

class ResponderPedidoAmizadeView {
    --
    +post(request, pk): HttpResponse
}

class ChatView {
    +template_name: String
    --
    +get_context_data(**kwargs): Dict
}

class BuscarNovasMensagensView {
    --
    +get(request, conversa_id): JsonResponse
}

class EnviarMensagemAjaxView {
    --
    +post(request, conversa_id): JsonResponse
}

' Middleware
class UsuarioOnlineMiddleware {
    +get_response: Callable
    --
    +__init__(get_response): void
    +__call__(request): HttpResponse
}

' Forms
class UsuarioCreationForm {
    --
    +save(): User
}

' Relacionamentos
User ||--|| Perfil : "1:1"
User ||--o{ Contato : "solicitante 1:N"
User ||--o{ Contato : "receptor 1:N"
User }o--o{ Conversa : "N:M participantes"
User ||--o{ Mensagem : "remetente 1:N"
Conversa ||--o{ Mensagem : "1:N"

' Relacionamentos das Views com Models
UserListView ..> User : "usa"
UserListView ..> Perfil : "usa"
EnviarPedidoAmizadeView ..> Contato : "cria"
MeusContatosView ..> Contato : "consulta"
ResponderPedidoAmizadeView ..> Contato : "atualiza"
ChatView ..> Conversa : "consulta"
ChatView ..> Mensagem : "consulta"
BuscarNovasMensagensView ..> Mensagem : "consulta"
EnviarMensagemAjaxView ..> Mensagem : "cria"

' Middleware relationship
UsuarioOnlineMiddleware ..> Perfil : "atualiza"

' Notes
note right of Perfil : "Propriedade esta_online\nverifica atividade nos\núltimos 5 minutos"
note right of Contato : "Status: pendente,\naceito, recusado"
note bottom of BuscarNovasMensagensView : "Retorna mensagens\nem formato JSON\npara AJAX"
note bottom of UsuarioOnlineMiddleware : "Atualiza automaticamente\na última atividade\ndo usuário logado"

@enduml</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instruções -->
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Como usar:</h5>
                            <ol>
                                <li>Clique no botão "Copiar" do diagrama desejado</li>
                                <li>Acesse <a href="http://www.plantuml.com/plantuml/uml/" target="_blank">PlantUML Online</a></li>
                                <li>Cole o código na área de texto</li>
                                <li>Clique em "Submit" para gerar o diagrama</li>
                                <li>Use as opções de export para salvar como PNG, SVG, etc.</li>
                            </ol>
                        </div>
                        
                        <div class="alert alert-success">
                            <h5><i class="fas fa-terminal"></i> Geração Local:</h5>
                            <p>Para gerar as imagens localmente, execute:</p>
                            <code>./gerar_diagramas.sh</code>
                            <p class="mt-2 mb-0">As imagens serão salvas em <code>static/core/diagramas/</code></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent || element.innerText;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
            showCopyMessage();
        });
    } else {
        // Fallback para navegadores mais antigos
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopyMessage();
    }
}

function showCopyMessage() {
    // Criar uma notificação temporária
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-check"></i> Código copiado para a área de transferência!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}
</script>
{% endblock %}
